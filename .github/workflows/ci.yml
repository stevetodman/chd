name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      code_changed: ${{ steps.detect.outputs.code }}
      migrations_changed: ${{ steps.filter.outputs.migrations }}
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a25f0e4a72 # v4.1.6
        with:
          fetch-depth: 0
      - name: Detect code changes
        id: detect
        run: |
          CODE_CHANGED=$(python3 scripts/detect_code_changes.py)
          echo "code=${CODE_CHANGED}" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_BASE_SHA: ${{ github.event.pull_request.base.sha || '' }}
          GITHUB_BEFORE_SHA: ${{ github.event.before || '' }}
          GITHUB_SHA: ${{ github.sha }}
      - uses: dorny/paths-filter@8d6a028232b48cf9449877dc87aef5d30daeb4c3 # v3.0.2
        id: filter
        with:
          filters: |
            migrations:
              - 'chd-qbank/supabase/migrations/**'

  build-test:
    needs: detect-changes
    if: needs.detect-changes.outputs.code_changed == 'true' || needs.detect-changes.outputs.migrations_changed == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: chd-qbank
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a25f0e4a72 # v4.1.6
      - uses: actions/setup-node@5e21ff4d9f0f45a73d87940c49aa5addf5328d0f # v4.0.2
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'chd-qbank/package-lock.json'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint -- --max-warnings=0
      - name: Type check
        run: npm run typecheck
      - name: Test
        run: npm run test -- --run --reporter=dot
      - run: npm run build
      - run: npm run notice
      - name: Generate license inventory
        working-directory: ..
        run: npm run license:inventory
      - name: Enforce license policy
        working-directory: ..
        run: npm run license:check
      - name: Upload unit test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-coverage
          path: chd-qbank/coverage
          if-no-files-found: ignore
      - name: Publish coverage summary
        if: always()
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = 'coverage/coverage-summary.json';
          if (!fs.existsSync(path)) {
            console.log('No coverage summary found.');
            process.exit(0);
          }
          const summary = JSON.parse(fs.readFileSync(path, 'utf8'));
          const total = summary.total;
          const lines = [
            '| Metric | % | Covered / Total |',
            '| --- | --- | --- |',
            `| Statements | ${total.statements.pct}% | ${total.statements.covered} / ${total.statements.total} |`,
            `| Branches | ${total.branches.pct}% | ${total.branches.covered} / ${total.branches.total} |`,
            `| Functions | ${total.functions.pct}% | ${total.functions.covered} / ${total.functions.total} |`,
            `| Lines | ${total.lines.pct}% | ${total.lines.covered} / ${total.lines.total} |`,
          ].join('\n');
          fs.writeFileSync(process.env.GITHUB_STEP_SUMMARY, `## Coverage Summary\n\n${lines}\n`);
          NODE
      - name: Generate SBOM (CycloneDX)
        if: always()
        run: |
          mkdir -p compliance-artifacts
          npx --yes @cyclonedx/cyclonedx-npm --output-file compliance-artifacts/chd-qbank-cyclonedx.json --output-format json
      - name: Capture npm audit report
        if: always()
        run: |
          mkdir -p compliance-artifacts
          npm audit --json > compliance-artifacts/npm-audit.json || true
      - name: Upload compliance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-artifacts
          path: chd-qbank/compliance-artifacts
      - name: Check Supabase migration safety
        if: needs.detect-changes.outputs.migrations_changed == 'true'
        run: npm run check:migration-safety
      - name: Ensure NOTICE and license inventory are current
        working-directory: ..
        run: git diff --exit-code

  edge-function-lint:
    needs: detect-changes
    if: needs.detect-changes.outputs.code_changed == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: chd-qbank/supabase/functions/signup-with-code
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a25f0e4a72 # v4.1.6
      - uses: denoland/setup-deno@db94c30a7d69dbab71c373b72ed9d6d8d3e15794 # v1.1.1
        with:
          deno-version: v1.x
      - run: deno lint
      - run: deno check index.ts
